# Подготовка и настройка бота

Уровень сложности: **продвинутый**

С навыками разработки вы можете создавать чат-ботов с неограниченным потенциалом и возможностью размещать мини-приложения в MAX.

---

## Подготовка

Вы можете [создать бота](../01_Создание_чат-бота/bots-create.md), только если у вас есть [верифицированный профиль организации](../02_Подключение_к_платформе/connection.md#верификация-организации) на платформе MAX для партнёров.

Для одной организации доступно создание **5 ботов**.

Пользователи могут получить доступ к боту после его успешной модерации. [Статус модерации](../01_Создание_чат-бота/bots-create.md#статусы-модерации) отображается рядом с названием бота.

### Настройки бота

У бота в MAX есть следующие поля или настройки:

- **Имя** — отображается в MAX в чате с вашим ботом, задаётся при создании бота в поле «Название»
- **Аватар (фото профиля)** — загружается в виде логотипа при создании бота
- **Ник** — отображается в публичной ссылке, например для `max.ru/idИНН_bot` ником является `idИНН_bot`. Генерируется автоматически при создании бота по шаблону `idИНН_bot`
- **Описание** — указано, какие задачи решает бот: что умеет, чем полезен, как связаться с его владельцем или поддержкой

> Настройки бота можно изменить только на платформе MAX для партнёров — отредактировать их в мессенджере MAX не получится.

Вы можете [изменить](#как-изменить-настройки-бота) имя, аватар и описание. Отредактировать ник пока нельзя. При изменении настроек обратите внимание на [требования к полям](../01_Создание_чат-бота/bots-create.md#настройки-бота).

Также в настройках бота на платформе вы можете [запретить или разрешить](#как-разрешить-или-запретить-добавление-бота-в-групповой-чат) добавление бота в групповой чат. По умолчанию установлен запрет.

### Токен бота

После успешной проверки бота в разделе «Интеграция» → «Получить токен» появится токен — уникальный идентификатор бота, с помощью которого он будет взаимодействовать с API MAX. Наличие токена означает, что бот зарегистрирован на платформе MAX для партнёров.

При необходимости токен можно [обновить](#как-обновить-токен-бота). Также вы можете добавить ссылку на [мини-приложение](../../04_Мини-приложения/introduction.md), которое хотите подключить к чат-боту.

**Пример токена:**
```
AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw
```

> **Важно:** Токен — это прямой доступ к боту. Не рекомендуем хранить его в открытых источниках или передавать посторонним — они смогут завладеть ботом и управлять им от вашего имени. Если вы опасаетесь, что токен скомпрометирован, [обновите его](#как-обновить-токен-бота).

Собрать сценарий для бота можно без кода, для этого есть конструкторы с набором готовых решений. Подробнее [в разделе «Бот без разработки»](../02_Бот_без_разработки/create.md).

---

## Отправляем API-запросы

API — это сервис, который позволяет взаимодействовать с платформой от имени бота. Бот отправляет запросы с токеном к [API MAX](../../API/README.md) и получает обновления с сервера в формате JSON.

> Передача токена через query-параметры больше не поддерживается — используйте заголовок `Authorization: <token>`

**Базовый запрос к API MAX:**

```
https://platform-api.max.ru/me?
Authorization: <token>
```

В ответ вернётся информация о боте — его имя, токен или ник.

> Для стабильной работы ботов убедитесь, что максимальное количество запросов в секунду на `platform-api.max.ru` — **30 rps**.

Подробнее о работе с сервером, методах и параметрах запросов читайте [в разделе «API»](../../API/README.md).

Если вы пишете ботов на TypeScript или JavaScript, рекомендуем использовать нашу официальную библиотеку — она содержит разные стандартные методы и утилиты. Читайте подробнее [в разделе «Библиотека MAX Bot API»](../03_Библиотека/01_JavaScript/library-js.md) или на [GitHub](https://github.com/max-messenger).

---

## Настраиваем уведомления

API MAX поддерживает два типа уведомлений о действиях пользователей с ботом:
1. **Webhook** — для production
2. **Long Polling** — для разработки и тестирования

Использовать одновременно их нельзя — выберите один из типов.

| Тип | Описание |
|-----|----------|
| **Webhook** | После новых действий в чат-боте сам отправляет запрос на сервер |
| **Long Polling** | Работает методом периодических запросов без триггера в боте |

Чтобы подключить уведомления, отправьте к API [POST-запрос /subscriptions](../../API/01_Методы_API/subscriptions/POST_subscriptions.md).
В запросе укажите URL, на который должна приходить информация о новых событиях с ботом.

### Webhook

Чтобы получить уведомления, выполните [GET-запрос /subscriptions](../../API/01_Методы_API/subscriptions/GET_subscriptions.md).

> Обратите внимание: для отправки вебхуков поддерживается только протокол HTTPS, включая самоподписанные сертификаты. HTTP не поддерживается.

### Long Polling

Чтобы получить уведомления, выполните [GET-запрос /updates](../../API/01_Методы_API/subscriptions/GET_updates.md).

---

## Работаем с диплинками

Диплинки (deep links) — это специальные ссылки, которые позволяют открывать чат-ботов MAX с передачей дополнительных параметров. С их помощью можно передавать контекстную информацию, отслеживать источники переходов или автоматически выполнять определённые действия при запуске.

### Создание диплинка бота

Чтобы создать диплинк бота, используйте следующий формат ссылки:

```
https://max.ru/<botName>?start=<payload>
```

Где:
- `<botName>` — ник бота
- `<payload>` — дополнительные данные (до 128 символов)

> Если payload превышает 128 символов, он не будет передан боту.

#### Примеры

**Базовая ссылка:**
```
https://max.ru/SupportBot?start=123
```

**Реферальная ссылка:**
```
https://max.ru/MyBot?start=ref_user456789
```

**Отслеживание источника:**
```
https://max.ru/NewsBot?start=source_site
```

### Payload в боте

#### Как получить payload в боте

Для получения обновлений с payload бот должен использовать Webhook или Long Polling.

При настройке Webhook убедитесь, что в параметре `update_types` включён тип `"bot_started"`.

Когда пользователь переходит по диплинку, бот получает обновление типа `bot_started` через Webhook или Long Polling:

```json
{
  "update_type": "bot_started",
  "timestamp": 1573226679188,
  "chat_id": 1234567890,
  "user": {
    "user_id": 1234567890,
    "name": "Иван",
    "username": "ivan_petrov"
  },
  "payload": "promo_summer2025"
}
```

**Ключевые поля в update:**
- `update_type` — всегда `"bot_started"` при запуске бота через диплинк
- `payload` — переданное значение из URL (может быть null, если параметр не указан)
- `user` — информация о пользователе, который запустил бота
- `chat_id` — ID чата

#### Можно ли передать несколько параметров в payload

Для получения нескольких параметров в payload их нужно закодировать в одну строку, например:

```
?start=param1_value1_param2_value2
```

---

## Управляем ботом в MAX

### Как изменить настройки бота

Изменить можно все [настройки](../01_Создание_чат-бота/bots-create.md#настройки-бота), кроме ника.

1. Перейдите на [платформу MAX для партнёров](https://business.max.ru/self)
2. Если у вас несколько ботов, в левом верхнем углу выберите нужный
3. Справа нажмите на значок настроек
4. Внесите изменения и нажмите «Сохранить» — бот будет отправлен на повторную [модерацию](../01_Создание_чат-бота/bots-create.md#статусы-модерации). Пока идёт проверка, бот остаётся в прежнем виде для конечных пользователей. Изменения применяются после успешной модерации.

### Как разрешить или запретить добавление бота в групповой чат

> Обратите внимание: если вы запретите включать бота в групповой чат, добавить его в канал тоже не получится.

1. Перейдите на [платформу MAX для партнёров](https://business.max.ru/self)
2. Если у вас несколько ботов, в левом верхнем углу выберите нужный
3. Перейдите в раздел «Чат-бот и мини-приложение» → «Настроить»
4. Включите или отключите возможность добавления бота в групповой чат и нажмите «Сохранить»

### Где посмотреть токен бота

1. Перейдите на [платформу MAX для партнёров](https://business.max.ru/self)
2. Если у вас несколько ботов, в левом верхнем углу выберите нужный
3. Перейдите в раздел «Интеграция» → «Получить токен» — токен находится в поле с одноимённым названием

### Как обновить токен бота

1. Перейдите на [платформу MAX для партнёров](https://business.max.ru/self)
2. Если у вас несколько ботов, в левом верхнем углу выберите нужный
3. Перейдите в раздел «Интеграция» → «Получить токен»
4. Справа от поля с токеном нажмите на значок обновления

### Как удалить бота

> **Внимание:** После удаления ваши клиенты не смогут пользоваться ботом. Удалённого бота нельзя восстановить.

1. Перейдите на [платформу MAX для партнёров](https://business.max.ru/self)
2. Если у вас несколько ботов, в левом верхнем углу выберите нужный
3. Справа нажмите на значок настроек
4. Нажмите «Удалить бота» и подтвердите удаление

---

## Добавляем приложение в MAX

После того как бот успешно прошёл модерацию, вы можете подключить к нему готовое мини-приложение в MAX.

Подробнее – [в документации мини-приложений](../../04_Мини-приложения/introduction.md#как-добавить-приложение-в-max)

---

Если у вас возникли вопросы, [посмотрите раздел с ответами](https://max.ru/help)
