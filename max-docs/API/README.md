# API MAX - Обзор

API (Application Programming Interface) — это посредник между разработчиком приложений и средой, с которой это приложение должно взаимодействовать. API упрощает написание кода за счёт набора готовых классов, функций или структур для работы с данными.

API MAX — это интерфейс, который позволяет ботам взаимодействовать с платформой и получать необходимые данные с помощью HTTPS-запросов к серверу.

---

## Методы

HTTPS-запросы на домен `platform-api.max.ru` вызывают методы — условные команды, которые соответствуют той или иной операции с базой данных.

### HTTP-методы

| Метод | Описание |
|-------|----------|
| **GET** | Получить ресурсы |
| **POST** | Создать ресурсы (например, отправить новые сообщения) |
| **PUT** | Редактировать ресурсы |
| **DELETE** | Удалить ресурсы |
| **PATCH** | Исправить ресурсы |

> Передача токена через query-параметры больше не поддерживается — используйте заголовок `Authorization: <token>`

### Примеры запросов

- `GET https://platform-api.max.ru/messages/{messageId}` — получить сообщения
- `POST https://platform-api.max.ru/messages` — отправить сообщения
- `PATCH https://platform-api.max.ru/chats/{chatId}` — изменить информацию о чате

В ответ сервер вернёт JSON-объект с запрошенными данными или сообщение об ошибке, если что-то пойдёт не так.

### Пример ответа на запрос к методу GET /me

```json
{
  "user_id": 1,
  "name": "My Bot",
  "username": "my_bot",
  "is_bot": true,
  "last_activity_time": 1737500130100
}
```

---

## Коды ответов HTTP

| Код | Описание |
|-----|----------|
| **200** | Успешная операция |
| **400** | Недействительный запрос |
| **401** | Ошибка аутентификации |
| **404** | Ресурс не найден |
| **405** | Метод не допускается |
| **429** | Превышено количество запросов |
| **503** | Сервис недоступен |

---

## Рекомендации по работе с API

Когда вы настраиваете получение обновлений о действиях в чат-боте, используйте:

- **Long Polling** — для разработки и тестирования
- **Webhook** — для production-окружения

> Для стабильной работы ботов убедитесь, что максимальное количество запросов в секунду на `platform-api.max.ru` — **30 rps**.

---

## Клавиатура

Клавиатура позволяет отправлять боту запросы кнопками, а не сообщениями. Чтобы клавиатура была удобной для пользователей, рекомендуем заранее продумать её наполнение и учитывать обязательные параметры:

- Текст на кнопке выравнивается по центру и обрезается, если выходит за её границы
- Кнопки в одной строке всегда одинаковой ширины
- Ширина каждого ряда кнопок равна ширине клавиатуры
- Высота у всех кнопок по умолчанию одинаковая

### Inline-клавиатура

Вы можете подключить к чат-боту в MAX inline-клавиатуру. Она позволяет разместить под сообщением бота до **210 кнопок**, сгруппированных в **30 рядов** — до **7 кнопок в каждом** (до **3**, если это кнопки типа `link`, `open_app`, `request_geo_location` или `request_contact`).

> Для кнопки с видом `link` максимальный размер ссылки составляет **2048 символов**.

### Виды кнопок для чат-бота

| Тип | Описание |
|-----|----------|
| **callback** | Сервер MAX отправляет событие с типом `message_callback` (через Webhook или Long polling) |
| **link** | Позволяет открыть ссылку в новой вкладке |
| **request_contact** | Запрашивает у пользователя его контакт и номер телефона |
| **request_geo_location** | Запрашивает у пользователя его местоположение |
| **open_app** | Открывает мини-приложение |
| **message** | Отправляет боту текстовое сообщение |

> Обратите внимание: для отправки вебхуков поддерживается только протокол HTTPS, включая самоподписанные сертификаты. HTTP не поддерживается.

### Пример добавления кнопок

```json
{
  "text": "It is message with inline keyboard",
  "attachments": [
    {
      "type": "inline_keyboard",
      "payload": {
        "buttons": [
          [
            {
              "type": "callback",
              "text": "Press me!",
              "payload": "button1 pressed"
            }
          ]
        ]
      }
    }
  ]
}
```

---

## Форматирование текста

Текст сообщения в чат-боте можно улучшить с помощью базового форматирования. Для этого вы можете использовать либо **Markdown**, либо **HTML**.

### Markdown

Чтобы включить разбор Markdown, установите свойство `format` в [NewMessageBody](./02_Объекты/NewMessageBody.md) на значение `markdown`.

| Markdown | Отображение |
|----------|-------------|
| `*emphasized*` или `_emphasized_` | *курсив* |
| `**strong**` или `__strong__` | **жирный** |
| `~~strikethough~~` | ~~зачёркнутый~~ |
| `++underline++` | ++подчёркнутый++ |
| `` `code` `` | `моноширинный` |
| `[Inline URL](https://dev.max.ru/)` | [ссылка] |
| User mention | `"text": "[Имя Фамилия](max://user/user_id)", "format": "markdown"` |

> Вместо User mention указывайте полное имя пользователя из профиля в MAX, в том числе фамилию. Если фамилия отсутствует — только имя.

### HTML

Чтобы включить разбор HTML, установите свойство `format` в [NewMessageBody](./02_Объекты/NewMessageBody.md) на значение `html`.

| HTML | Отображение |
|------|-------------|
| `<i>` или `<em>` | курсив |
| `<b>` или `<strong>` | жирный |
| `<del>` или `<s>` | зачёркнутый |
| `<ins>` или `<u>` | подчёркнутый |
| `<pre>` или `<code>` | моноширинный |
| `<a href="...">` | ссылка |
| User mention | `"text": "<a href=\"max://user/user_id\">Имя Фамилия</a>", "format": "html"` |

---

Если у вас возникли вопросы, [посмотрите раздел с ответами](https://max.ru/help)
